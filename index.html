<head>
  <style> body { margin: 0; } </style>

  <script src="./globe.gl"></script>
</head>

<body>
  <div id="globeViz"></div>

  <script type="module">

    // Convert UTC offset string (e.g. "UTC+05:30") to minutes
    function parseOffset(offsetStr) {
      if (!offsetStr) return 0;
      const sign = offsetStr.startsWith('UTC-') ? -1 : 1;
      const parts = offsetStr.replace('UTC', '').replace(/[+-]/, '').split(':');
      const [hours, minutes = "0"] = parts;
      return sign * (parseInt(hours, 10) * 60 + parseInt(minutes, 10));
    }

    // Get current time adjusted by offset
    function getLocalTimeFromOffset(offsetStr) {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      const offsetMinutes = parseOffset(offsetStr);
      const localTime = new Date(utc + offsetMinutes * 60000);
      return localTime.toTimeString().split(' ')[0]; // HH:MM:SS
    }

    fetch('./timezones_am.json').then(res => res.json()).then(countries => {
      let hoveredId = null;

      const world = new Globe(document.getElementById('globeViz'))
        .globeImageUrl('./earth-night.jpg')
        .backgroundImageUrl('./night-sky.png')
        .lineHoverPrecision(0)
        .polygonsData(countries.features)
        .polygonAltitude(d =>
          hoveredId && d.properties.id === hoveredId ? 0.12 : 0.06
        )
        .polygonCapColor(d =>
          hoveredId && d.properties.id === hoveredId ? '#ffffff' : '#666666'
        )
        .polygonSideColor(() => 'rgba(0,0,0,0.3)')
        .polygonStrokeColor(() => '#222')
        .polygonLabel(({ properties: d }) => {
          const offset = d.id;
          const time = getLocalTimeFromOffset(offset);
          return `<b>${offset}</b><br/>ðŸ•’ ${time}`;
        })
        .onPolygonHover(d => {
          hoveredId = d ? d.properties.id : null;
          world.polygonsData(world.polygonsData()); // refresh
        })
        .polygonsTransitionDuration(200);
    });
  </script>
</body>
