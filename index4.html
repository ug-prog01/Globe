<head>
  <style> body { margin: 0; } </style>

  <script src="//cdn.jsdelivr.net/npm/globe.gl"></script>
  <!-- <script src="../../dist/globe.gl.js"></script> -->
</head>

<body>
  <div id="globeViz"></div>

  <script type="module">
    import { scaleSequentialSqrt } from 'https://esm.sh/d3-scale';
    import { interpolateYlOrRd } from 'https://esm.sh/d3-scale-chromatic';

	// Convert UTC offset string (e.g. "+05:30") to minutes
    function parseOffset(offsetStr) {
      if (!offsetStr) return 0;
      const sign = offsetStr.startsWith('UTC-') ? -1 : 1;
	  const stringre = offsetStr.replace('UTC', '').replace(/[+-]/, '').split(':');
      const [hours, minutes = "0"] = stringre;
      return sign * (parseInt(hours, 10) * 60 + parseInt(minutes, 10));
    }

    // Get current time adjusted by offset
    function getLocalTimeFromOffset(offsetStr) {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      const offsetMinutes = parseOffset(offsetStr);
      const localTime = new Date(utc + offsetMinutes * 60000);
      return localTime.toTimeString().split(' ')[0]; // HH:MM:SS
    }

    fetch('./am_data.json').then(res => res.json()).then(countries =>
    {
	  console.log(countries.features);

      const world = new Globe(document.getElementById('globeViz'))
        .globeImageUrl('//cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg')
        .backgroundImageUrl('//cdn.jsdelivr.net/npm/three-globe/example/img/night-sky.png')
        .lineHoverPrecision(0)
        .polygonsData(countries.features)
        .polygonAltitude(0.06)
        .polygonCapColor('red')
        .polygonSideColor(() => 'rgba(0, 100, 0, 0.15)')
        .polygonStrokeColor(() => '#111')
        .polygonLabel(({ properties: d }) => {
		  const offset = d.id;
		  const time = getLocalTimeFromOffset(offset);
          return `<b>${offset}</b><br/>ðŸ•’ ${time}`;
        })
        .onPolygonHover(hoverD => world
          .polygonAltitude(d => d === hoverD ? 0.12 : 0.06)
          .polygonCapColor(d => d === hoverD ? 'steelblue' : 'red')
        )
        .polygonsTransitionDuration(300);
    });
  </script>
</body>